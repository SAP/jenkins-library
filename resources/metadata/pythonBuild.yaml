metadata:
  name: pythonBuild
  description: Step builds a python project
  longDescription: |
    This step will build a python project.
    It will prioritize `pyproject.toml` file but can also be used with a `setup.py` manifest and builds a wheel and tarball artifact.

    ### Build with depedencies from a private repository

    If your build has dependencies from a private repository you can include the standard `requirements.txt` into the source code with `--extra-index-url` as the first line

    ```
    --extra-index-url https://${PIPER_VAULTCREDENTIAL_USERNAME}:${PIPER_VAULTCREDENTIAL_PASSWORD}@<privateRepoUrl>/simple
    ```

    The variables `PIPER_VAULTCREDENTIAL_USERNAME` and `PIPER_VAULTCREDENTIAL_PASSWORD` are the username and password environemtn variables for the private repository must be present in the environment where the Piper step runs or alternatively can be created using [vault general purpose credentials](../infrastructure/vault.md#using-vault-for-general-purpose-and-test-credentials).
spec:
  inputs:
    params:
      - name: buildFlags
        type: "[]string"
        description: Defines list of build flags passed to python binary.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: setupFlags
        type: "[]string"
        description: Defines list of flags passed to setup.py / build module.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: createBOM
        type: bool
        description: Creates the bill of materials (BOM) using CycloneDX plugin.
        scope:
          - GENERAL
          - STEPS
          - STAGES
          - PARAMETERS
        default: false
      - name: publish
        type: bool
        description: Configures the build to publish artifacts to a repository.
        scope:
          - STEPS
          - STAGES
          - PARAMETERS
        default: false
      - name: targetRepositoryPassword
        description: "Password for the target repository where the compiled binaries shall be uploaded - typically provided by the CI/CD environment."
        type: string
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        secret: true
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/repositoryPassword
      - name: targetRepositoryUser
        description: "Username for the target repository where the compiled binaries shall be uploaded - typically provided by the CI/CD environment."
        type: string
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        secret: true
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/repositoryUsername
      - name: targetRepositoryURL
        description: "URL of the target repository where the compiled binaries shall be uploaded - typically provided by the CI/CD environment."
        type: string
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/repositoryUrl
      - name: buildSettingsInfo
        type: string
        description: build settings info is typically filled by the step automatically to create information about the build settings that were used during the build. This information is typically used for compliance related processes.
        scope:
          - STEPS
          - STAGES
          - PARAMETERS
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/buildSettingsInfo
      - name: virtualEnvironmentName
        type: string
        description: name of the virtual environment that will be used for the build
        scope:
          - STEPS
          - STAGES
          - PARAMETERS
        default: piperBuild-env
        aliases:
          - name: virutalEnvironmentName  # typo alias - to be removed in future releases
            deprecated: true
      - name: requirementsFilePath
        type: string
        description: file path to the requirements.txt file needed for the sbom cycloneDx file creation.
        scope:
          - STEPS
          - STAGES
          - PARAMETERS
        default: requirements.txt
      - name: additionalEventData
        type: string
        description: "Optional JSON object to be merged into the CloudEvent data for this step."
        scope:
          - GENERAL
          - STAGES
          - STEPS
          - PARAMETERS
        mandatory: false
        resourceRef:
          - name: commonPipelineEnvironment
            param: custom/additionalEventData
  outputs:
    resources:
      - name: commonPipelineEnvironment
        type: piperEnvironment
        params:
          - name: custom/buildSettingsInfo
          - name: custom/additionalEventData
  containers:
    - name: python
      image: python:3.11
