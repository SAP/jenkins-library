metadata:
  name: gctsExecuteABAPUnitTests
  description: Runs ABAP unit tests and ATC (ABAP Test Cockpit) Checks for the specified scope. 
  longDescription: |
    This step will execute every unit test and ATC Checks for the specified scope of a local repository on an ABAP system.
    In total there are six scopes. You can specify one of the following scopes based on your use case.
      1.	LOCAL_CHANGED_OBJECTS - delta between commit that triggered the pipeline and the last local commit
      2.	LOCAL_CHANGED_PACKAGES – delta between commit that triggered the pipeline and the last local commit. Objects will be resolved into packages.
      3.	REMOTE_CHANGED_OBJECTS - delta between commit that triggered the pipeline and the last remote commit.
      4.	REMOTE_CHANGED_PACKAGES - delta between commit that triggered the pipeline and the last remote commit. Objects will be resolved into packages.
      5.	ALL_PACKAGES – all packages which belong to the repository 
      6.	REPOSITORY – all objects which belong to the repository
    In addition, this step gives you the flexibility to choose whether you want to execute only units tests or only ATC checks or both. By default, both unit test and ATC checks will be executed.
    The results of Unit Tests and ATC checks are stored in a checkstyle format. In Jenkins with the help of Static Analysis Warning Plug-In you can view the issues founds and navigate to the exact line of the source code where the issue occurred. For your information the source code is an object in ABAP system or a file in a Git repository.
    You can use gCTSExecuteABAPUnitTests as of SAP S/4HANA 2020.
spec:
  inputs:
    secrets:
      - name: abapCredentialsId
        description: Jenkins credentials ID containing username and password for authentication to the ABAP system on which you want to perform the unit tests and ATC Checks
        type: jenkins
    params:
      - name: username
        type: string
        description: User to authenticate to the ABAP system. Note – Do not provide this parameter directly. Either set it in the environment, or in the Jenkins credentials store, and provide the ID as value of the abapCredentialsId parameter.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        mandatory: true
        secret: true
        resourceRef:
          - name: abapCredentialsId
            type: secret
            param: username
      - name: password
        type: string
        description: Password to authenticate to the ABAP system. . Note – Do not provide this parameter directly. Either set it in the environment, or in the Jenkins credentials store, and provide the ID as value of the abapCredentialsId parameter.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        mandatory: true
        secret: true
        resourceRef:
          - name: abapCredentialsId
            type: secret
            param: password
      - name: repository
        type: string
        description: Specifies the name (ID) of the local repsitory on the ABAP system
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        mandatory: true
      - name: host
        type: string
        description: Specifies the protocol and host address, including the port. Please provide in the format `<protocol>://<host>:<port>`. Supported protocols are `http` and `https`.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        mandatory: true
      - name: client
        type: string
        description: Specifies the client of the ABAP system to be addressed
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        mandatory: true
      - name: scope
        type: string
        enum:
          - CHANGED
          - PACKAGE
          - REPOSITORY  
        description: Specifies the scope of objects to be tested. In total there are six predefined scopes LOCAL_CHANGED_OBJECTS, LOCAL_CHANGED_PACKAGES, REMOTE_CHANGED_OBJECTS, REMOTE_CHANGED_PACKAGES, , REPOSITORY and ALL_PACKAGES.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        mandatory: true    
      - name: commitId
        type: string
        description: The commit that triggered the pipeline
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        mandatory: true
      - name: aUnitTest
        type: bool
        default: true
        description: Specifies whether to execute Unit Tests
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: ATCCheck
        type: bool
        default: true
        description: Specifies whether to execute ATC Check
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: workspace
        type: string
        description: The absolute path to job workspace directory 
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        mandatory: true
 
