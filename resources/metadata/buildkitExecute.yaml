metadata:
  name: buildkitExecute
  description: Executes a Buildkit build for creating a Docker container.
  longDescription: |
    Executes a Buildkit build for creating a Docker container.

spec:
  inputs:
    secrets:
      - name: dockerConfigJsonCredentialsId
        description: Jenkins 'Secret file' credentials ID containing Docker config.json (with registry credential(s))
        type: jenkins
    params:
      - name: buildOptions
        type: "[]string"
        description: Defines a list of build options for buildkit
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: []
      - name: dockerfilePath
        type: string
        description: Defines the location of the Dockerfile relative to the pipeline working directory.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: .
      - name: createBOM
        type: bool
        description: Creates the BOM using Syft and stores it in a file
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: false
      - name: syftDownloadURL
        type: string
        description: URL to download syft from. If not specified, the default URL from pkg/syft/defaults.go will be used
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: ""
      - name: containerImageName
        aliases:
          - name: dockerImageName
        type: string
        description: Name of the container which will be built
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
      - name: containerImageTag
        aliases:
          - name: artifactVersion
        type: string
        description: Tag of the container which will be built
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
        resourceRef:
          - name: commonPipelineEnvironment
            param: artifactVersion
      - name: containerRegistryUrl
        aliases:
          - name: dockerRegistryUrl
        type: string
        description: URL of the container registry where the image should be pushed to
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
        resourceRef:
          - name: commonPipelineEnvironment
            param: container/registryUrl
      - name: dockerConfigJSON
        type: string
        description: Path to the file `.docker/config.json` containing docker credentials
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        secret: true
        resourceRef:
          - name: dockerConfigJsonCredentialsId
            type: secret

  outputs:
    resources:
      - name: commonPipelineEnvironment
        type: piperEnvironment
        params:
          - name: container/registryUrl
          - name: container/imageNameTag
          - name: container/imageNames
            type: "[]string"
          - name: container/imageNameTags
            type: "[]string"
      - name: reports
        type: reports
        params:
          - filePattern: "**/bom-*.xml"
            type: sbom

  containers:
  - name: buildkitd
    image: moby/buildkit:v0.12.0-rootless
    command:
      - /bin/sh
    args:
      - -ec
      - |
        mkdir -p /run/buildkit
        exec /usr/bin/rootlesskit \
          --net=slirp4netns \
          --copy-up=/etc \
          --copy-up=/run \
          --propagation=rslave \
          /usr/bin/buildkitd \
            --addr=unix:///run/buildkit/buildkitd.sock \
            --oci-worker-no-process-sandbox \
            --containerd-worker=false \
            --debug
    readinessProbe:
      exec:
        command: ["/bin/sh", "-c", "buildctl --addr unix:///run/buildkit/buildkitd.sock debug workers"]
      initialDelaySeconds: 2
      periodSeconds: 5
      timeoutSeconds: 3
    startupProbe:
      exec:
        command: ["/bin/sh", "-c", "test -S /run/buildkit/buildkitd.sock"]
      failureThreshold: 30
      periodSeconds: 2
    env:
      - name: HOME
        value: /home/user
      - name: USER
        value: user
      - name: BUILDKIT_HOST
        value: "unix:///run/buildkit/buildkitd.sock"
      - name: XDG_RUNTIME_DIR
        value: /run/buildkit
      - name: BUILDKIT_STEP_LOG_MAX_SIZE
        value: "10485760"
      - name: BUILDKIT_STEP_LOG_MAX_SPEED
        value: "1048576"
      - name: BUILDKIT_DEBUG
        value: "1"
      - name: PATH
        value: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      allowPrivilegeEscalation: false
      capabilities:
        add:
          - CHOWN
          - SETUID
          - SETGID
          - FOWNER
          - DAC_OVERRIDE
          - SYS_CHROOT
          - MKNOD
      seccompProfile:
        type: RuntimeDefault
      runAsNonRoot: true
    volumeMounts:
      - name: volume
        mountPath: /run/buildkit
        subPath: buildkit-data
      - name: volume
        mountPath: /workspace
        subPath: workspace
      - name: volume
        mountPath: /home/user/.docker
        subPath: docker-config
      - name: volume
        mountPath: /tmp
        subPath: tmp-data
  volumes:
    - name: volume
      emptyDir:
        medium: Memory
        sizeLimit: 10Gi
