metadata:
  name: buildkitExecute
  description: Executes a Buildkit build for creating a Docker container.
  longDescription: |
    Executes a Buildkit build for creating a Docker container.

spec:
  inputs:
    secrets:
      - name: dockerConfigJsonCredentialsId
        description: Jenkins 'Secret file' credentials ID containing Docker config.json (with registry credential(s))
        type: jenkins
    params:
      - name: buildOptions
        type: "[]string"
        description: Defines a list of build options for buildkit
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: []
      - name: dockerfilePath
        type: string
        description: Defines the location of the Dockerfile relative to the pipeline working directory.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: .
      - name: createBOM
        type: bool
        description: Creates the BOM using Syft and stores it in a file
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: false
      - name: syftDownloadURL
        type: string
        description: URL to download syft from. If not specified, the default URL from pkg/syft/defaults.go will be used
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: ""
      - name: containerImageName
        aliases:
          - name: dockerImageName
        type: string
        description: Name of the container which will be built
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
      - name: containerImageTag
        aliases:
          - name: artifactVersion
        type: string
        description: Tag of the container which will be built
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
        resourceRef:
          - name: commonPipelineEnvironment
            param: artifactVersion
      - name: containerRegistryUrl
        aliases:
          - name: dockerRegistryUrl
        type: string
        description: URL of the container registry where the image should be pushed to
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
        resourceRef:
          - name: commonPipelineEnvironment
            param: container/registryUrl
      - name: dockerConfigJSON
        type: string
        description: Path to the file `.docker/config.json` containing docker credentials
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        secret: true
        resourceRef:
          - name: dockerConfigJsonCredentialsId
            type: secret

  outputs:
    resources:
      - name: commonPipelineEnvironment
        type: piperEnvironment
        params:
          - name: container/registryUrl
          - name: container/imageNameTag
          - name: container/imageNames
            type: "[]string"
          - name: container/imageNameTags
            type: "[]string"
      - name: reports
        type: reports
        params:
          - filePattern: "**/bom-*.xml"
            type: sbom

  containers:
    - name: buildkitd
      image: moby/buildkit:latest
      securityContext:
        privileged: true
      volumeMounts:
        - name: buildkit-socket
          mountPath: /run/buildkit
  volumes:
    - name: buildkit-socket
      emptyDir: {}
