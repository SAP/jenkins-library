metadata:
  name: terraformExecute
  description: Executes Terraform
  longDescription: |
    This step executes the terraform binary with the given command, and is able to fetch additional variables from vault.
spec:
  inputs:
    secrets:
      - name: terraformConfigFileCredentialsId
        description: Jenkins 'Secret file' credentials ID containing terraform CLI configuration. You can find more details about it in the [Terraform documentation](https://www.terraform.io/docs/cli/config/config-file.html#credentials).
        type: jenkins
    params:
      - name: command
        type: string
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: plan
      - name: terraformSecrets
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        type: string
        resourceRef:
          - type: vaultSecretFile
            name: terraformExecuteFileVaultSecret
            default: terraformExecute
      - name: globalOptions
        type: "[]string"
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: additionalArgs
        type: "[]string"
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: init
        type: bool
        descriptions: Executes terraform init prior to the configured command.
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        default: false
      - name: terraformConfigFile
        type: string
        description: Path to the terraform CLI configuration file (https://www.terraform.io/docs/cli/config/config-file.html#credentials).
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        secret: true
        resourceRef:
          - name: terraformConfigFileCredentialsId
            type: secret
          - type: vaultSecretFile
            name: terraformConfigFileVaultSecretName
            default: terraform
  containers:
    - name: terraform
      image: hashicorp/terraform:0.14.7
      options:
        - name: --entrypoint
          value: ''
      env:
        - name: TF_IN_AUTOMATION
          value: piper
